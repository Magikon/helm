ARG DOCKER_VERSION=19.03.2
ARG ALPINE_VERSION=3.10.2
FROM docker:${DOCKER_VERSION} as dockerbase

ARG ALPINE_VERSION=${ALPINE_VERSION}
FROM alpine:${ALPINE_VERSION}

ARG KUBEVAL_VERSION=0.14.0
ARG HELM_VERSION=v2.14.3
ARG CLOUD_SDK_VERSION=263.0.0

ENV KUBEVAL_VERSION=${KUBEVAL_VERSION}
ENV HELM_VERSION=${HELM_VERSION}
ENV CLOUD_SDK_VERSION=${CLOUD_SDK_VERSION}
ENV DOCKER_CLI_EXPERIMENTAL=enabled

ENV PATH=$PATH:/google-cloud-sdk/bin

COPY ./functions/. /usr/local/bin/

RUN apk --update add --no-cache ca-certificates curl jq gettext findutils tar gzip bash python git openssh-client

RUN curl -L https://github.com/instrumenta/kubeval/releases/download/${KUBEVAL_VERSION}/kubeval-linux-amd64.tar.gz | tar xz -C /tmp && mv /tmp/kubeval /usr/local/bin/kubeval && find /tmp/* | xargs rm -f

COPY --from=dockerbase /usr/local/bin/docker /usr/local/bin/docker

COPY --from=google/cloud-sdk /usr/bin/kubectl /usr/local/bin/kubectl

RUN curl -L https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz | tar xvz && mv linux-amd64/helm /usr/local/bin/helm && \
    mv linux-amd64/tiller /usr/local/bin/tiller && rm -rf linux-amd64 && helm init --client-only

RUN curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-${CLOUD_SDK_VERSION}-linux-x86_64.tar.gz && \
    tar xzf google-cloud-sdk-${CLOUD_SDK_VERSION}-linux-x86_64.tar.gz && rm google-cloud-sdk-${CLOUD_SDK_VERSION}-linux-x86_64.tar.gz

VOLUME ["/root/.config"]